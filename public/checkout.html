<script>
/* -------------------------
   CART (from localStorage)
   ------------------------- */
let cart = JSON.parse(localStorage.getItem('cart')) || [];

/* -------------------------
   DOM REFS
   ------------------------- */
const cartSummaryEl = document.getElementById('cart-summary');
const cartSummary2El = document.getElementById('cart-summary-2');
const checkoutForm = document.getElementById('checkout-form');
const step1El = document.getElementById('step1');
const step2El = document.getElementById('step2');
const backBtn = document.getElementById('back-btn');
const paypalContainer = document.getElementById('paypal-button-container');

/* -------------------------
   SHIPPING API INTEGRATION
   ------------------------- */
let shippingRates = [];
let selectedShipping = null;

async function fetchShippingRates(){
  const originPostal = 'M5V1E3'; // warehouse
  const destPostal = 'M5V1E3';   // placeholder destination
  try {
    const response = await fetch('https://your-api.com/rates', {
      method:'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ originPostal, destPostal, items: cart })
    });
    const data = await response.json();
    shippingRates = data.rates || [];
    selectedShipping = shippingRates[0] || { service: 'Standard', price: 0 };
  } catch(err){
    console.error('Shipping API error', err);
    shippingRates = [];
    selectedShipping = { service: 'Standard', price: 0 };
  }
  renderCartWithShipping(cartSummaryEl);
  renderCartWithShipping(cartSummary2El);
}

/* -------------------------
   CART + SHIPPING RENDER
   ------------------------- */
function calcSubtotal(){
  return cart.reduce((s,i)=>s + (i.price * i.qty),0);
}

function renderCartWithShipping(el){
  if(!el) return; // <-- stop if element doesn't exist
  el.innerHTML = '';

  if(!cart.length){
    el.innerHTML = "<p>Your cart is empty.</p>";
    return;
  }

  // Items
  cart.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `<div>${item.name} x ${item.qty}</div><div>$${(item.price*item.qty).toFixed(2)} CAD</div>`;
    el.appendChild(div);
  });

  const subtotal = calcSubtotal();
  const shippingCost = selectedShipping ? parseFloat(selectedShipping.price) : 0;
  const total = subtotal + shippingCost;

  // Shipping selector
  const shippingDiv = document.createElement('div');
  shippingDiv.className = 'summary-line';
  shippingDiv.innerHTML = `<label>Shipping</label><select id="shipping-select"></select>`;
  el.appendChild(shippingDiv);

  const shippingSelect = el.querySelector('#shipping-select');
  if(shippingSelect){
    if(shippingRates.length){
      shippingRates.forEach((r,i)=>{
        const o = document.createElement('option');
        o.value = r.price;
        o.textContent = `${r.service} - $${parseFloat(r.price).toFixed(2)}`;
        if(i===0) o.selected=true;
        shippingSelect.appendChild(o);
      });
      shippingSelect.addEventListener('change', e=>{
        selectedShipping = {
          service: shippingSelect.options[shippingSelect.selectedIndex].text.split(' - ')[0],
          price: parseFloat(e.target.value)
        };
        renderCartWithShipping(el);
      });
    } else {
      const o = document.createElement('option');
      o.textContent='Standard - $0.00';
      o.value=0;
      shippingSelect.appendChild(o);
    }
  }

  // Totals
  [['Subtotal', subtotal], ['Shipping', shippingCost], ['Total', total]].forEach(l=>{
    const ln=document.createElement('div');
    ln.className='summary-line';
    ln.innerHTML=`<div>${l[0]}</div><div>$${l[1].toFixed(2)} CAD</div>`;
    el.appendChild(ln);
  });

  // store current totals for PayPal
  el.dataset.subtotal = subtotal.toFixed(2);
  el.dataset.shipping = shippingCost.toFixed(2);
  el.dataset.total = total.toFixed(2);
}

/* -------------------------
   CHECKOUT STEP LOGIC
   ------------------------- */
if(checkoutForm){
  checkoutForm.addEventListener('submit', e=>{
    e.preventDefault();
    if(!cart.length) return alert('Your cart is empty.');

    // Show Step 2
    step1El.style.display = 'none';
    step2El.style.display = 'block';

    // Render PayPal safely
    if(paypalContainer){
      renderPayPalButton();
    }
  });
}

if(backBtn){
  backBtn.addEventListener('click', ()=>{
    step2El.style.display='none';
    step1El.style.display='block';
  });
}

/* -------------------------
   PAYPAL BUTTON (dummy example)
   ------------------------- */
function renderPayPalButton(){
  if(!paypalContainer) return;
  paypalContainer.innerHTML = `<p>PayPal button goes here (total: $${cartSummary2El.dataset.total} CAD)</p>`;
}

/* -------------------------
   INITIAL RENDER
   ------------------------- */
fetchShippingRates();
renderCartWithShipping(cartSummaryEl);
renderCartWithShipping(cartSummary2El);
</script>
