<script>
document.addEventListener("DOMContentLoaded", () => {
  const shippingSelect = document.getElementById('shipping'); // your shipping dropdown
  const priceInput = document.getElementById('price'); // product price
  const totalEl = document.getElementById('total'); // total display
  const postalInput = document.getElementById('postal'); // customer postal code input

  async function loadShippingRates(postalCode) {
    try {
      const res = await fetch('/api/canadapost-rate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          weight: 0.015,
          length: 15,
          width: 5,
          height: 10,
          destinationPostalCode: postalCode
        })
      });

      const text = await res.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, 'application/xml');
      const ns = "http://www.canadapost.ca/ws/ship/rate-v4";
      const quotes = Array.from(xml.getElementsByTagNameNS(ns, 'price-quote'));

      shippingSelect.innerHTML = '';
      if (!quotes.length) {
        shippingSelect.innerHTML = '<option value="">No rates available</option>';
        return;
      }

      shippingSelect.innerHTML = '<option value="">-- Select Shipping --</option>';
      quotes.forEach(q => {
        const name = q.getElementsByTagNameNS(ns, 'service-name')[0]?.textContent || 'Unknown';
        const due = parseFloat(q.getElementsByTagNameNS(ns, 'due')[0]?.textContent || 0);
        const option = document.createElement('option');
        option.value = due;
        option.textContent = `${name} - $${due.toFixed(2)}`;
        shippingSelect.appendChild(option);
      });

      updateTotal();
    } catch (err) {
      console.error(err);
      shippingSelect.innerHTML = '<option value="">Error loading rates</option>';
    }
  }

  function updateTotal() {
    const price = parseFloat(priceInput.value) || 0;
    const shipping = parseFloat(shippingSelect.value) || 0;
    totalEl.textContent = `Total: $${(price + shipping).toFixed(2)}`;
  }

  // Update total when shipping option or price changes
  shippingSelect.addEventListener('change', updateTotal);
  priceInput.addEventListener('input', updateTotal);

  // Load rates when postal code changes
  postalInput.addEventListener('input', () => {
    const code = postalInput.value.trim();
    if (code.length >= 6) loadShippingRates(code); // minimal length check
  });

  // Initial load with default postal code if you have one
  if (postalInput.value) loadShippingRates(postalInput.value.trim());
});
</script>
