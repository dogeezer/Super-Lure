const express = require('express');
const bodyParser = require('body-parser');
const fetch = require('node-fetch');
const xml2js = require('xml2js');

const app = express();
app.use(bodyParser.json());

app.post('/api/canadapost-rate', async (req, res) => {
  const { destinationPostalCode, serviceCode, weight, dimensions, originPostalCode } = req.body;

  const xmlBody = `
    <mailing-scenario xmlns="http://www.canadapost.ca/ws/ship/rate-v4">
      <customer-number>0001223271</customer-number>
      <parcel-characteristics>
        <weight>${weight}</weight>
        <dimensions>
          <length>${dimensions.length}</length>
          <width>${dimensions.width}</width>
          <height>${dimensions.height}</height>
        </dimensions>
      </parcel-characteristics>
      <origin-postal-code>${originPostalCode}</origin-postal-code>
      <destination>
        <domestic>
          <postal-code>${destinationPostalCode}</postal-code>
        </domestic>
      </destination>
    </mailing-scenario>
  `;

  try {
    const response = await fetch('https://soa-gw.canadapost.ca/rs/ship/rate-v4', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/vnd.cpc.ship.rate-v4+xml',
        'Accept': 'application/vnd.cpc.ship.rate-v4+xml',
        'Authorization': 'Basic ' + Buffer.from('username:password').toString('base64')
      },
      body: xmlBody
    });

    const xml = await response.text();

    // Convert XML to JSON
    xml2js.parseString(xml, { explicitArray: false }, (err, result) => {
      if (err) return res.json({ error: 'Failed to parse Canada Post response' });

      // Find the price quote matching the requested service
      const quotes = result['price-quotes']['price-quote'];
      const quoteArray = Array.isArray(quotes) ? quotes : [quotes];
      const priceQuote = quoteArray.find(q => q['service-code'] === serviceCode);

      res.json({ priceQuote });
    });

  } catch (err) {
    console.error(err);
    res.json({ error: 'Failed to fetch Canada Post rate' });
  }
});

app.listen(10000, () => console.log('N0B1M0 server running on port 10000'));
