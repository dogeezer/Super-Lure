<!DOCTYPE html>
</html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Super Lure Checkout</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  body { font-family:'Roboto', sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; }
  header { background:#000; color:white; padding:20px; text-align:center; }
  h1,h2 { text-align:center; }
  .content { padding:30px; max-width:1000px; margin:20px auto; background:white; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.08); }
  .cart-summary { margin-bottom:20px; }
  .cart-item { display:flex; justify-content:space-between; margin-bottom:10px; }
  form label { display:block; margin-top:10px; font-weight:bold; }
  form input, form textarea, form select { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
  form textarea { resize:vertical; min-height:80px; }
  button { padding:10px 18px; background:#3B5998; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }
  button:hover { background:#2b4f7a; }
  .required-star { color:red; }
  .button-container { display:flex; justify-content:center; gap:18px; margin-top:20px; flex-wrap:wrap; }
  .phone-container { display:flex; gap:8px; align-items:center; }
  select.country-code { width:30%; min-width:140px; font-size:13px; }
  #paypal-button-container { margin-top:20px; }
  #back-btn { background:#777; margin-top:15px; padding:8px 14px; font-size:14px; cursor:pointer; border-radius:6px; color:white; border:none; }
  .two-col { display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:start; }
  .summary-line { display:flex; justify-content:space-between; padding:4px 0; }
  .summary-total { font-weight:700; font-size:1.05rem; margin-top:8px; }
  .small { font-size:0.9rem; color:#555; }
</style>
</head>
<body>

<header>
  <h1>Super Lure Checkout</h1>
</header>

<section class="content">

  <!-- Step 1 -->
  <div id="step1">
    <h2>Order Summary</h2>
    <div class="cart-summary" id="cart-summary"></div>

    <h2>Shipping & Billing Info</h2>

    <form id="checkout-form" novalidate>
      <label>Full Name <span class="required-star">*</span></label>
      <input type="text" id="name" required>

      <label>Email <span class="required-star">*</span></label>
      <input type="email" id="email" required pattern=".+\.com$" title="Email must end with .com">

      <!-- Country & State/Province (user requested between email and address) -->
      <div class="two-col" style="margin-top:10px;">
        <div>
          <label>Country <span class="required-star">*</span></label>
          <select id="country" required></select>
        </div>
        <div>
          <label>State / Province <span class="required-star">*</span></label>
          <select id="subdivision" required>
            <option value="">-- Select country first --</option>
          </select>
        </div>
      </div>

      <label style="margin-top:12px;">Address <span class="required-star">*</span></label>
      <input type="text" id="address" required>

      <label>Phone <span class="required-star">*</span></label>
      <div class="phone-container">
        <select name="country_code" id="country_code" class="country-code" required></select>
        <input type="tel" id="phone" placeholder="Phone number" required style="flex:1;"/>
      </div>

      <label>Additional Info</label>
      <textarea id="additional" placeholder="Optional notes..."></textarea>

      <div class="button-container">
        <button type="button" id="exit-btn" style="background:#777;">Exit Checkout</button>
        <button type="submit" id="to-payment">Continue to Payment</button>
      </div>
    </form>
  </div>

  <!-- Step 2 -->
  <div id="step2" style="display:none;">
    <h2>Order Summary</h2>
    <div class="cart-summary" id="cart-summary-2"></div>
    <div id="paypal-button-container"></div>
    <button id="back-btn">← Back to Info</button>
  </div>

</section>

<script>
/* -------------------------
   CART (from localStorage)
   ------------------------- */
let cart = JSON.parse(localStorage.getItem('cart')) || [
  // demo item if cart empty (remove for production)
  // { id:1, name:"Demo Lure", price:7.60, qty:2 }
];
/* For testing, you can temporarily uncomment demo above. */

function totalQuantity() {
  return cart.reduce((s,i)=>s + (i.qty || 0), 0);
}

/* -------------------------
   CONFIG: shipping & tax
   ------------------------- */
const SHIPPING_PER_ITEM = 1.28; // $1.28 per item (user requested)
const DEFAULT_COUNTRY_TAX = 0.10; // fallback

/* country-level tax mapping (common countries). Add more here as needed.
   Note: This is a best-effort mapping of widely-used VAT/GST rates.
   For production tax accuracy, integrate a tax provider (Avalara/TaxJar/etc.).
*/
const countryTaxRates = {
  "CA": 0.00, // Canada handled by province/subdivision mapping below
  "US": 0.00, // handled by state mapping below (state-level)
  "GB": 0.20, // United Kingdom VAT
  "FR": 0.20, // France VAT
  "DE": 0.19, // Germany VAT
  "IT": 0.22, // Italy VAT
  "ES": 0.21, // Spain VAT
  "AU": 0.10, // Australia GST
  "JP": 0.10, // Japan consumption tax
  "IN": 0.18, // India GST (typical)
  "CN": 0.13, // China VAT (standard rate)
  "BR": 0.12, // Brazil - simplified placeholder (varies by product)
  "MX": 0.16, // Mexico VAT
  "RU": 0.20, // Russia VAT
  "ZA": 0.15, // South Africa VAT
  "NZ": 0.15, // New Zealand GST
  "CH": 0.077, // Switzerland VAT
  // many countries default to 0 if not present
};

/* subdivision (state/province) tax rates for Canada (combined rates) */
const subdivisions = {
  "CA": {
    "ON": { name:"Ontario", tax:0.13 },
    "QC": { name:"Quebec", tax:0.14975 }, // combined (GST+QST)
    "BC": { name:"British Columbia", tax:0.12 },
    "AB": { name:"Alberta", tax:0.05 },
    "MB": { name:"Manitoba", tax:0.12 },
    "SK": { name:"Saskatchewan", tax:0.11 },
    "NS": { name:"Nova Scotia", tax:0.15 },
    "NB": { name:"New Brunswick", tax:0.15 },
    "PE": { name:"Prince Edward Island", tax:0.15 },
    "NL": { name:"Newfoundland and Labrador", tax:0.13 },
    "NT": { name:"Northwest Territories", tax:0.05 },
    "YT": { name:"Yukon", tax:0.05 },
    "NU": { name:"Nunavut", tax:0.05 }
  },

  /* US states with state-level base sales tax rates
     Note: Many US localities add local taxes. This mapping uses state base rates (common baseline).
     If you need local/combined rates, integrate a tax API. */
  "US": {
    "AL": { name:"Alabama", tax:0.04 },
    "AK": { name:"Alaska", tax:0.00 }, // no statewide sales tax
    "AZ": { name:"Arizona", tax:0.056 },
    "AR": { name:"Arkansas", tax:0.065 },
    "CA": { name:"California", tax:0.0725 },
    "CO": { name:"Colorado", tax:0.029 },
    "CT": { name:"Connecticut", tax:0.0635 },
    "DE": { name:"Delaware", tax:0.00 },
    "FL": { name:"Florida", tax:0.06 },
    "GA": { name:"Georgia", tax:0.04 },
    "HI": { name:"Hawaii", tax:0.04 },
    "ID": { name:"Idaho", tax:0.06 },
    "IL": { name:"Illinois", tax:0.0625 },
    "IN": { name:"Indiana", tax:0.07 },
    "IA": { name:"Iowa", tax:0.06 },
    "KS": { name:"Kansas", tax:0.065 },
    "KY": { name:"Kentucky", tax:0.06 },
    "LA": { name:"Louisiana", tax:0.0445 },
    "ME": { name:"Maine", tax:0.055 },
    "MD": { name:"Maryland", tax:0.06 },
    "MA": { name:"Massachusetts", tax:0.0625 },
    "MI": { name:"Michigan", tax:0.06 },
    "MN": { name:"Minnesota", tax:0.06875 },
    "MS": { name:"Mississippi", tax:0.07 },
    "MO": { name:"Missouri", tax:0.04225 },
    "MT": { name:"Montana", tax:0.00 },
    "NE": { name:"Nebraska", tax:0.055 },
    "NV": { name:"Nevada", tax:0.0685 },
    "NH": { name:"New Hampshire", tax:0.00 },
    "NJ": { name:"New Jersey", tax:0.06625 },
    "NM": { name:"New Mexico", tax:0.05125 },
    "NY": { name:"New York", tax:0.04 },
    "NC": { name:"North Carolina", tax:0.0475 },
    "ND": { name:"North Dakota", tax:0.05 },
    "OH": { name:"Ohio", tax:0.0575 },
    "OK": { name:"Oklahoma", tax:0.045 },
    "OR": { name:"Oregon", tax:0.00 },
    "PA": { name:"Pennsylvania", tax:0.06 },
    "RI": { name:"Rhode Island", tax:0.07 },
    "SC": { name:"South Carolina", tax:0.06 },
    "SD": { name:"South Dakota", tax:0.045 },
    "TN": { name:"Tennessee", tax:0.07 },
    "TX": { name:"Texas", tax:0.0625 },
    "UT": { name:"Utah", tax:0.0485 },
    "VT": { name:"Vermont", tax:0.06 },
    "VA": { name:"Virginia", tax:0.043 },
    "WA": { name:"Washington", tax:0.065 },
    "WV": { name:"West Virginia", tax:0.06 },
    "WI": { name:"Wisconsin", tax:0.05 },
    "WY": { name:"Wyoming", tax:0.04 },
    "DC": { name:"District of Columbia", tax:0.06 }
  }
};

/* -------------------------
   COUNTRY LIST (full)
   ------------------------- */
/* You provided the full country list earlier — reproduced here so nothing is omitted.
   Each option includes a data-country-code attribute for two-letter ISO where possible.
*/
const countryOptions = [
  { iso:"AF", name:"Afghanistan (+93)", dial:"+93" },
  { iso:"AL", name:"Albania (+355)", dial:"+355" },
  { iso:"DZ", name:"Algeria (+213)", dial:"+213" },
  { iso:"AS", name:"American Samoa (+1)", dial:"+1" },
  { iso:"AD", name:"Andorra (+376)", dial:"+376" },
  { iso:"AO", name:"Angola (+244)", dial:"+244" },
  { iso:"AI", name:"Anguilla (+1)", dial:"+1" },
  { iso:"AQ", name:"Antarctica (+672)", dial:"+672" },
  { iso:"AG", name:"Antigua & Barbuda (+672)", dial:"+672" },
  { iso:"AR", name:"Argentina (+54)", dial:"+54" },
  { iso:"AM", name:"Armenia (+374)", dial:"+374" },
  { iso:"AW", name:"Aruba (+297)", dial:"+297" },
  { iso:"AU", name:"Australia (+61)", dial:"+61" },
  { iso:"AT", name:"Austria (+43)", dial:"+43" },
  { iso:"AZ", name:"Azerbaijan (+994)", dial:"+994" },
  { iso:"BS", name:"Bahamas (+1)", dial:"+1" },
  { iso:"BH", name:"Bahrain (+973)", dial:"+973" },
  { iso:"BD", name:"Bangladesh (+880)", dial:"+880" },
  { iso:"BB", name:"Barbados (+1)", dial:"+1" },
  { iso:"BY", name:"Belarus (+375)", dial:"+375" },
  { iso:"BE", name:"Belgium (+32)", dial:"+32" },
  { iso:"BZ", name:"Belize (+501)", dial:"+501" },
  { iso:"BJ", name:"Benin (+229)", dial:"+229" },
  { iso:"BM", name:"Bermuda (+1)", dial:"+1" },
  { iso:"BT", name:"Bhutan (+975)", dial:"+975" },
  { iso:"BO", name:"Bolivia (+591)", dial:"+591" },
  { iso:"BA", name:"Bosnia & Herzegovina (+387)", dial:"+387" },
  { iso:"BW", name:"Botswana (+267)", dial:"+267" },
  { iso:"BR", name:"Brazil (+55)", dial:"+55" },
  { iso:"IO", name:"British Indian Ocean Territory (+246)", dial:"+246" },
  { iso:"VG", name:"British Virgin Islands (+1)", dial:"+1" },
  { iso:"BN", name:"Brunei (+673)", dial:"+673" },
  { iso:"BG", name:"Bulgaria (+359)", dial:"+359" },
  { iso:"BF", name:"Burkina Faso (+226)", dial:"+226" },
  { iso:"BI", name:"Burundi (+257)", dial:"+257" },
  { iso:"KH", name:"Cambodia (+855)", dial:"+855" },
  { iso:"CM", name:"Cameroon (+237)", dial:"+237" },
  { iso:"CA", name:"Canada (+1)", dial:"+1" },
  { iso:"CV", name:"Cape Verde (+238)", dial:"+238" },
  { iso:"KY", name:"Cayman Islands (+345)", dial:"+345" },
  { iso:"CF", name:"Central African Republic (+236)", dial:"+236" },
  { iso:"TD", name:"Chad (+235)", dial:"+235" },
  { iso:"CL", name:"Chile (+56)", dial:"+56" },
  { iso:"CN", name:"China (+86)", dial:"+86" },
  { iso:"CX", name:"Christmas Island (+61)", dial:"+61" },
  { iso:"CC", name:"Cocos (Keeling) Islands (+61)", dial:"+61" },
  { iso:"CO", name:"Colombia (+57)", dial:"+57" },
  { iso:"KM", name:"Comoros (+269)", dial:"+269" },
  { iso:"CG", name:"Congo (+242)", dial:"+242" },
  { iso:"CD", name:"Congo, Democratic Republic (+243)", dial:"+243" },
  { iso:"CK", name:"Cook Islands (+682)", dial:"+682" },
  { iso:"CR", name:"Costa Rica (+506)", dial:"+506" },
  { iso:"CI", name:"Côte d’Ivoire (+225)", dial:"+225" },
  { iso:"HR", name:"Croatia (+385)", dial:"+385" },
  { iso:"CU", name:"Cuba (+53)", dial:"+53" },
  { iso:"CW", name:"Curaçao (+599)", dial:"+599" },
  { iso:"CY", name:"Cyprus (+357)", dial:"+357" },
  { iso:"CZ", name:"Czech Republic (+420)", dial:"+420" },
  { iso:"DK", name:"Denmark (+45)", dial:"+45" },
  { iso:"DJ", name:"Djibouti (+253)", dial:"+253" },
  { iso:"DM", name:"Dominica (+1)", dial:"+1" },
  { iso:"DO", name:"Dominican Republic (+1)", dial:"+1" },
  { iso:"EC", name:"Ecuador (+593)", dial:"+593" },
  { iso:"EG", name:"Egypt (+20)", dial:"+20" },
  { iso:"SV", name:"El Salvador (+503)", dial:"+503" },
  { iso:"GQ", name:"Equatorial Guinea (+240)", dial:"+240" },
  { iso:"ER", name:"Eritrea (+291)", dial:"+291" },
  { iso:"EE", name:"Estonia (+372)", dial:"+372" },
  { iso:"ET", name:"Ethiopia (+251)", dial:"+251" },
  { iso:"FK", name:"Falkland Islands (+500)", dial:"+500" },
  { iso:"FO", name:"Faroe Islands (+298)", dial:"+298" },
  { iso:"FJ", name:"Fiji (+679)", dial:"+679" },
  { iso:"FI", name:"Finland (+358)", dial:"+358" },
  { iso:"FR", name:"France (+33)", dial:"+33" },
  { iso:"GF", name:"French Guiana (+594)", dial:"+594" },
  { iso:"PF", name:"French Polynesia (+689)", dial:"+689" },
  { iso:"GA", name:"Gabon (+241)", dial:"+241" },
  { iso:"GM", name:"Gambia (+220)", dial:"+220" },
  { iso:"GE", name:"Georgia (+995)", dial:"+995" },
  { iso:"DE", name:"Germany (+49)", dial:"+49" },
  { iso:"GH", name:"Ghana (+233)", dial:"+233" },
  { iso:"GI", name:"Gibraltar (+350)", dial:"+350" },
  { iso:"GR", name:"Greece (+30)", dial:"+30" },
  { iso:"GL", name:"Greenland (+299)", dial:"+299" },
  { iso:"GD", name:"Grenada (+1)", dial:"+1" },
  { iso:"GP", name:"Guadeloupe (+590)", dial:"+590" },
  { iso:"GU", name:"Guam (+1)", dial:"+1" },
  { iso:"GT", name:"Guatemala (+502)", dial:"+502" },
  { iso:"GG", name:"Guernsey (+44)", dial:"+44" },
  { iso:"GN", name:"Guinea (+224)", dial:"+224" },
  { iso:"GW", name:"Guinea-Bissau (+245)", dial:"+245" },
  { iso:"GY", name:"Guyana (+592)", dial:"+592" },
  { iso:"HT", name:"Haiti (+509)", dial:"+509" },
  { iso:"HN", name:"Honduras (+504)", dial:"+504" },
  { iso:"HK", name:"Hong Kong (+852)", dial:"+852" },
  { iso:"HU", name:"Hungary (+36)", dial:"+36" },
  { iso:"IS", name:"Iceland (+354)", dial:"+354" },
  { iso:"IN", name:"India (+91)", dial:"+91" },
  { iso:"ID", name:"Indonesia (+62)", dial:"+62" },
  { iso:"IR", name:"Iran (+98)", dial:"+98" },
  { iso:"IQ", name:"Iraq (+964)", dial:"+964" },
  { iso:"IE", name:"Ireland (+353)", dial:"+353" },
  { iso:"IL", name:"Israel (+44)", dial:"+44" },
  { iso:"IT", name:"Italy (+39)", dial:"+39" },
  { iso:"JM", name:"Jamaica (+1)", dial:"+1" },
  { iso:"JP", name:"Japan (+81)", dial:"+81" },
  { iso:"JE", name:"Jersey (+44)", dial:"+44" },
  { iso:"JO", name:"Jordan (+962)", dial:"+962" },
  { iso:"KZ", name:"Kazakhstan (+7)", dial:"+7" },
  { iso:"KE", name:"Kenya (+254)", dial:"+254" },
  { iso:"KI", name:"Kiribati (+686)", dial:"+686" },
  { iso:"XK", name:"Kosovo (+383)", dial:"+383" },
  { iso:"KW", name:"Kuwait (+965)", dial:"+965" },
  { iso:"KG", name:"Kyrgyzstan (+996)", dial:"+996" },
  { iso:"LV", name:"Latvia (+371)", dial:"+371" },
  { iso:"LB", name:"Lebanon (+961)", dial:"+961" },
  { iso:"LS", name:"Lesotho (+266)", dial:"+266" },
  { iso:"LR", name:"Liberia (+231)", dial:"+231" },
  { iso:"LY", name:"Libya (+218)", dial:"+218" },
  { iso:"LI", name:"Liechtenstein (+423)", dial:"+423" },
  { iso:"LT", name:"Lithuania (+370)", dial:"+370" },
  { iso:"LU", name:"Luxembourg (+352)", dial:"+352" },
  { iso:"MO", name:"Macao (+853)", dial:"+853" },
  { iso:"MK", name:"Macedonia (+389)", dial:"+389" },
  { iso:"MG", name:"Madagascar (+261)", dial:"+261" },
  { iso:"MW", name:"Malawi (+265)", dial:"+265" },
  { iso:"MY", name:"Malaysia (+60)", dial:"+60" },
  { iso:"MV", name:"Maldives (+960)", dial:"+960" },
  { iso:"ML", name:"Mali (+223)", dial:"+223" },
  { iso:"MT", name:"Malta (+356)", dial:"+356" },
  { iso:"MH", name:"Marshall Islands (+692)", dial:"+692" },
  { iso:"MR", name:"Mauritania (+222)", dial:"+222" },
  { iso:"MU", name:"Mauritius (+230)", dial:"+230" },
  { iso:"YT", name:"Mayotte (+262)", dial:"+262" },
  { iso:"MX", name:"Mexico (+52)", dial:"+52" },
  { iso:"FM", name:"Micronesia (+691)", dial:"+691" },
  { iso:"MD", name:"Moldova (+373)", dial:"+373" },
  { iso:"MC", name:"Monaco (+377)", dial:"+377" },
  { iso:"MN", name:"Mongolia (+976)", dial:"+976" },
  { iso:"ME", name:"Montenegro (+382)", dial:"+382" },
  { iso:"MS", name:"Montserrat (+1)", dial:"+1" },
  { iso:"MA", name:"Morocco (+212)", dial:"+212" },
  { iso:"MZ", name:"Mozambique (+258)", dial:"+258" },
  { iso:"MM", name:"Myanmar (+95)", dial:"+95" },
  { iso:"NA", name:"Namibia (+264)", dial:"+264" },
  { iso:"NR", name:"Nauru (+674)", dial:"+674" },
  { iso:"NP", name:"Nepal (+977)", dial:"+977" },
  { iso:"NL", name:"Netherlands (+31)", dial:"+31" },
  { iso:"NC", name:"New Caledonia (+687)", dial:"+687" },
  { iso:"NZ", name:"New Zealand (+64)", dial:"+64" },
  { iso:"NI", name:"Nicaragua (+505)", dial:"+505" },
  { iso:"NE", name:"Niger (+227)", dial:"+227" },
  { iso:"NG", name:"Nigeria (+234)", dial:"+234" },
  { iso:"NU", name:"Niue (+683)", dial:"+683" },
  { iso:"NF", name:"Norfolk Island (+672)", dial:"+672" },
  { iso:"MP", name:"Northern Mariana Islands (+1)", dial:"+1" },
  { iso:"NO", name:"Norway (+47)", dial:"+47" },
  { iso:"OM", name:"Oman (+968)", dial:"+968" },
  { iso:"PK", name:"Pakistan (+92)", dial:"+92" },
  { iso:"PW", name:"Palau (+680)", dial:"+680" },
  { iso:"PS", name:"Palestine (+970)", dial:"+970" },
  { iso:"PA", name:"Panama (+507)", dial:"+507" },
  { iso:"PG", name:"Papua New Guinea (+675)", dial:"+675" },
  { iso:"PY", name:"Paraguay (+595)", dial:"+595" },
  { iso:"PE", name:"Peru (+51)", dial:"+51" },
  { iso:"PH", name:"Philippines (+63)", dial:"+63" },
  { iso:"PL", name:"Poland (+48)", dial:"+48" },
  { iso:"PT", name:"Portugal (+351)", dial:"+351" },
  { iso:"PR", name:"Puerto Rico (+1)", dial:"+1" },
  { iso:"QA", name:"Qatar (+974)", dial:"+974" },
  { iso:"RO", name:"Romania (+40)", dial:"+40" },
  { iso:"RU", name:"Russia (+7)", dial:"+7" },
  { iso:"RW", name:"Rwanda (+250)", dial:"+250" },
  { iso:"BL", name:"Saint Barthélemy (+590)", dial:"+590" },
  { iso:"SH", name:"Saint Helena (+1)", dial:"+1" },
  { iso:"PM", name:"Saint Pierre & Miquelon (+590)", dial:"+590" },
  { iso:"KN", name:"Saint Kitts & Nevis (+1)", dial:"+1" },
  { iso:"LC", name:"Saint Lucia (+1)", dial:"+1" },
  { iso:"VC", name:"Saint Vincent & Grenadines (+1)", dial:"+1" },
  { iso:"WS", name:"Samoa (+685)", dial:"+685" },
  { iso:"SM", name:"San Marino (+378)", dial:"+378" },
  { iso:"ST", name:"São Tomé & Príncipe (+239)", dial:"+239" },
  { iso:"SA", name:"Saudi Arabia (+966)", dial:"+966" },
  { iso:"SN", name:"Senegal (+221)", dial:"+221" },
  { iso:"RS", name:"Serbia (+381)", dial:"+381" },
  { iso:"SC", name:"Seychelles (+248)", dial:"+248" },
  { iso:"SL", name:"Sierra Leone (+232)", dial:"+232" },
  { iso:"SG", name:"Singapore (+65)", dial:"+65" },
  { iso:"SK", name:"Slovakia (+421)", dial:"+421" },
  { iso:"SI", name:"Slovenia (+386)", dial:"+386" },
  { iso:"SB", name:"Solomon Islands (+677)", dial:"+677" },
  { iso:"SO", name:"Somalia (+252)", dial:"+252" },
  { iso:"ZA", name:"South Africa (+27)", dial:"+27" },
  { iso:"KR", name:"South Korea (+82)", dial:"+82" },
  { iso:"ES", name:"Spain (+34)", dial:"+34" },
  { iso:"LK", name:"Sri Lanka (+94)", dial:"+94" },
  { iso:"SD", name:"Sudan (+249)", dial:"+249" },
  { iso:"SR", name:"Suriname (+597)", dial:"+597" },
  { iso:"SJ", name:"Svalbard & Jan Mayen (+47)", dial:"+47" },
  { iso:"SZ", name:"Eswatini (+268)", dial:"+268" },
  { iso:"SE", name:"Sweden (+46)", dial:"+46" },
  { iso:"CH", name:"Switzerland (+41)", dial:"+41" },
  { iso:"SY", name:"Syria (+963)", dial:"+963" },
  { iso:"TW", name:"Taiwan (+886)", dial:"+886" },
  { iso:"TJ", name:"Tajikistan (+992)", dial:"+992" },
  { iso:"TZ", name:"Tanzania (+255)", dial:"+255" },
  { iso:"TH", name:"Thailand (+66)", dial:"+66" },
  { iso:"TL", name:"Timor-Leste (+670)", dial:"+670" },
  { iso:"TG", name:"Togo (+228)", dial:"+228" },
  { iso:"TK", name:"Tokelau (+690)", dial:"+690" },
  { iso:"TO", name:"Tonga (+676)", dial:"+676" },
  { iso:"TT", name:"Trinidad & Tobago (+1)", dial:"+1" },
  { iso:"TN", name:"Tunisia (+216)", dial:"+216" },
  { iso:"TR", name:"Turkey (+90)", dial:"+90" },
  { iso:"TM", name:"Turkmenistan (+993)", dial:"+993" },
  { iso:"TC", name:"Turks & Caicos Islands (+1)", dial:"+1" },
  { iso:"TV", name:"Tuvalu (+688)", dial:"+688" },
  { iso:"UG", name:"Uganda (+256)", dial:"+256" },
  { iso:"UA", name:"Ukraine (+380)", dial:"+380" },
  { iso:"AE", name:"United Arab Emirates (+971)", dial:"+971" },
  { iso:"GB", name:"United Kingdom (+44)", dial:"+44" },
  { iso:"US", name:"United States (+1)", dial:"+1" },
  { iso:"UY", name:"Uruguay (+598)", dial:"+598" },
  { iso:"UZ", name:"Uzbekistan (+998)", dial:"+998" },
  { iso:"VU", name:"Vanuatu (+678)", dial:"+678" },
  { iso:"VA", name:"Vatican City (+39)", dial:"+39" },
  { iso:"VE", name:"Venezuela (+58)", dial:"+58" },
  { iso:"VN", name:"Vietnam (+84)", dial:"+84" },
  { iso:"WF", name:"Wallis & Futuna (+681)", dial:"+681" },
  { iso:"YE", name:"Yemen (+967)", dial:"+967" },
  { iso:"ZM", name:"Zambia (+260)", dial:"+260" },
  { iso:"ZW", name:"Zimbabwe (+263)", dial:"+263" }
];

/* -------------------------
   DOM refs
   ------------------------- */
const cartSummaryEl = document.getElementById('cart-summary');
const cartSummary2El = document.getElementById('cart-summary-2');
const countryEl = document.getElementById('country');
const subdivisionEl = document.getElementById('subdivision');
const countryCodeEl = document.getElementById('country_code');

/* populate country & country code lists */
function populateCountries() {
  countryOptions.forEach(co => {
    const opt = document.createElement('option');
    opt.value = co.iso;
    opt.dataset.dial = co.dial;
    opt.textContent = `${co.name}`;
    countryEl.appendChild(opt);
  });

  // country code (for phone)
  countryOptions.forEach(co => {
    const opt = document.createElement('option');
    opt.value = co.dial;
    opt.textContent = `${co.name}`;
    countryCodeEl.appendChild(opt);
  });

  // sensible defaults (Canada)
  countryEl.value = 'CA';
  countryCodeEl.value = '+1';
}
populateCountries();

/* update subdivision dropdown based on selected country */
function populateSubdivisions(countryIso) {
  subdivisionEl.innerHTML = ''; // clear
  if (!countryIso) {
    subdivisionEl.innerHTML = '<option value="">-- Select country first --</option>';
    return;
  }
  if (subdivisions[countryIso]) {
    const map = subdivisions[countryIso];
    const empty = document.createElement('option');
    empty.value = '';
    empty.textContent = '-- Select state/province --';
    subdivisionEl.appendChild(empty);
    Object.keys(map).forEach(code=>{
      const o = document.createElement('option');
      o.value = code;
      o.textContent = map[code].name + (map[code].tax ? ` (${(map[code].tax*100).toFixed(2)}%)` : '');
      subdivisionEl.appendChild(o);
    });
    subdivisionEl.disabled = false;
  } else {
    // No subdivisions pre-defined: show "No subdivisions" option
    const o = document.createElement('option');
    o.value = '__none';
    o.textContent = 'No state/province (use country-level tax)';
    subdivisionEl.appendChild(o);
    subdivisionEl.disabled = true;
  }
}

/* -------------------------
   Totals calculation + rendering
   ------------------------- */
function calcSubtotal() {
  return cart.reduce((s,i)=>s + (i.price * i.qty), 0);
}
function calcShipping() {
  return SHIPPING_PER_ITEM * totalQuantity();
}
function getSelectedTaxRate() {
  const countryIso = countryEl.value;
  const sub = subdivisionEl.value;

  // priority: subdivision tax (if we have it)
  if (subdivisions[countryIso] && subdivisions[countryIso][sub]) {
    return subdivisions[countryIso][sub].tax || 0;
  }

  // else fallback to country-level mapping
  if (countryTaxRates[countryIso]) return countryTaxRates[countryIso];
  return DEFAULT_COUNTRY_TAX;
}

/* render cart summary into an element id */
function renderCart(el) {
  const target = (typeof el === 'string') ? document.getElementById(el) : el;
  target.innerHTML = '';
  if (!cart || cart.length === 0) {
    target.innerHTML = "<p>Your cart is empty.</p>";
    return;
  }

  // Items
  cart.forEach(item=>{
    const div = document.createElement('div');
    div.className = 'cart-item';
    const name = document.createElement('div');
    name.textContent = `${item.name} x ${item.qty}`;
    const price = document.createElement('div');
    price.textContent = `$${(item.price * item.qty).toFixed(2)} CAD`;
    div.appendChild(name); div.appendChild(price);
    target.appendChild(div);
  });

  // Subtotal / shipping / tax / total
  const subtotal = calcSubtotal();
  const shipping = calcShipping();
  const taxRate = getSelectedTaxRate();
  const tax = subtotal * taxRate;
  const total = subtotal + shipping + tax;

  const lines = [
    {label:'Subtotal', value: subtotal},
    {label:`Shipping (${totalQuantity()} item(s) × $${SHIPPING_PER_ITEM.toFixed(2)})`, value: shipping},
    {label:`Tax (${(taxRate*100).toFixed(2)}%)`, value: tax},
  ];

  lines.forEach(l=>{
    const ln = document.createElement('div');
    ln.className = 'summary-line';
    ln.innerHTML = `<div class="small">${l.label}</div><div class="small">$${l.value.toFixed(2)} CAD</div>`;
    target.appendChild(ln);
  });

  const totalDiv = document.createElement('div');
  totalDiv.className = 'summary-total';
  totalDiv.innerHTML = `<div class="summary-line"><div>Total</div><div>$${total.toFixed(2)} CAD</div></div>`;
  target.appendChild(totalDiv);

  // store current totals to be used in PayPal createOrder
  target.dataset.subtotal = subtotal.toFixed(2);
  target.dataset.shipping = shipping.toFixed(2);
  target.dataset.tax = tax.toFixed(2);
  target.dataset.total = total.toFixed(2);
}

/* initial render */
populateSubdivisions(countryEl.value);
renderCart(cartSummaryEl);
renderCart(cartSummary2El);

/* -------------------------
   Events: update when country/subdivision change
   ------------------------- */
countryEl.addEventListener('change', ()=>{
  // update phone country code automatically if possible
  const selOpt = countryEl.options[countryEl.selectedIndex];
  if (selOpt && selOpt.dataset && selOpt.dataset.dial) {
    countryCodeEl.value = selOpt.dataset.dial;
  }
  populateSubdivisions(countryEl.value);
  renderCart(cartSummaryEl);
  renderCart(cartSummary2El);
});

subdivisionEl.addEventListener('change', ()=>{
  renderCart(cartSummaryEl);
  renderCart(cartSummary2El);
});

/* -------------------------
   Checkout behavior
   ------------------------- */
document.getElementById('exit-btn').addEventListener('click', ()=> window.location.href='index.html');

document.getElementById('checkout-form').addEventListener('submit', function(e){
  e.preventDefault();

  // basic validation (HTML5 handles required; ensure subdivision chosen if enabled)
  if (subdivisionEl.disabled === false && !subdivisionEl.value) {
    alert('Please select a state / province.');
    return;
  }

  // switch to payment step
  document.getElementById('step1').style.display = 'none';
  document.getElementById('step2').style.display = 'block';

  // render order summary for step 2
  renderCart(cartSummary2El);

  // Wait for PayPal SDK script to load before rendering buttons
  if (window.paypal) {
    renderPaypalButtons();
  } else {
    console.warn('PayPal SDK not ready yet — creating script tag now.');
    loadPaypalAndRender();
  }
});

/* Back button */
document.getElementById('back-btn').addEventListener('click', ()=>{
  document.getElementById('step2').style.display = 'none';
  document.getElementById('step1').style.display = 'block';
});

/* -------------------------
   PayPal integration
   ------------------------- */
const PAYPAL_CLIENT_ID = "AZPob5p8BVkFnCvv698dRuJvNJyNz27PZlwD86gO6LzqZJvbbrx4a2MuLqH1IfXsvNdBKgOgDDcTLXQk"; // replace if necessary

function loadPaypalAndRender() {
  const script = document.createElement('script');
  script.src = `https://www.paypal.com/sdk/js?client-id=${encodeURIComponent(PAYPAL_CLIENT_ID)}&currency=CAD`;
  script.async = true;
  script.onload = () => {
    renderPaypalButtons();
  };
  script.onerror = () => {
    console.error('Failed to load PayPal SDK');
    alert('Unable to load PayPal. Please try again later.');
  };
  document.head.appendChild(script);
}

function buildPurchaseUnitBreakdown() {
  const subtotal = parseFloat(cartSummary2El.dataset.subtotal || '0');
  const shipping = parseFloat(cartSummary2El.dataset.shipping || '0');
  const tax = parseFloat(cartSummary2El.dataset.tax || '0');
  const total = parseFloat(cartSummary2El.dataset.total || '0');

  // Items array for PayPal (each item should include name, unit_amount, quantity)
  const items = cart.map(it => ({
    name: it.name,
    unit_amount: { currency_code: 'CAD', value: (it.price).toFixed(2) },
    quantity: String(it.qty)
  }));

  const breakdown = {
    item_total: { currency_code:'CAD', value: subtotal.toFixed(2) },
    shipping: { currency_code:'CAD', value: shipping.toFixed(2) },
    tax_total: { currency_code:'CAD', value: tax.toFixed(2) }
  };

  return { items, breakdown, total };
}

function renderPaypalButtons() {
  // clear old buttons if any
  const container = document.getElementById('paypal-button-container');
  container.innerHTML = '';

  const pu = buildPurchaseUnitBreakdown();

  // render PayPal buttons with breakdown
  paypal.Buttons({
    style:{ layout:'vertical', color:'gold', shape:'rect', label:'paypal' },
    createOrder: (data, actions) => {
      return actions.order.create({
        purchase_units: [{
          amount: {
            currency_code: 'CAD',
            value: pu.total.toFixed(2),
            breakdown: pu.breakdown
          },
          items: pu.items
        }],
        application_context: {
          shipping_preference: 'NO_SHIPPING' // we collect shipping outside PayPal
        }
      });
    },
    onApprove: (data, actions) => actions.order.capture().then(details => {
      alert('✅ Payment completed by ' + (details.payer?.name?.given_name || 'customer') + '. Thank you!');
      // Clear cart, redirect
      localStorage.removeItem('cart');
      window.location.href = 'index.html';
    }),
    onError: (err) => {
      console.error(err);
      alert('❌ Payment failed. See console for details.');
    }
  }).render('#paypal-button-container');
}

/* Load PayPal SDK early so it's available when user proceeds */
loadPaypalAndRender();

/* -------------------------
   Utility: initial render of cart and demo fallback
   ------------------------- */
function ensureDemoIfEmpty() {
  // if cart empty, provide demo content so totals show — remove in production
  if (!cart || cart.length === 0) {
    // Uncomment following to provide demo items for local testing:
    // cart = [{ id:1, name:"Crankbait", price:2.22, qty:3 }, {id:2, name:"Spinner", price:0.98, qty:2}];
    // localStorage.setItem('cart', JSON.stringify(cart));
  }
}
ensureDemoIfEmpty();

/* initial render after everything loaded */
renderCart('cart-summary');
renderCart('cart-summary-2');

</script>

</body>
</html>
