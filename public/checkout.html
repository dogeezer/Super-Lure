<script>
/* -------------------------
   CART (from localStorage)
   ------------------------- */
let cart = JSON.parse(localStorage.getItem('cart')) || [];

/* -------------------------
   DOM REFS
   ------------------------- */
const cartSummaryEl = document.getElementById('cart-summary');
const cartSummary2El = document.getElementById('cart-summary-2');
const step1 = document.getElementById('step1');
const step2 = document.getElementById('step2');
const checkoutForm = document.getElementById('checkout-form');

/* -------------------------
   SHIPPING API INTEGRATION
   ------------------------- */
let shippingRates = [];
let selectedShipping = { service: 'Standard', price: 0 };

// Example fetch function (replace URL with your real API endpoint)
async function fetchShippingRates(){
  const originPostal = 'M5V1E3'; // your warehouse
  const destPostal = 'M5V1E3';   // placeholder destination
  try {
    const response = await fetch('https://your-api.com/rates', {
      method:'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        originPostal, destPostal, items: cart
      })
    });
    const data = await response.json();
    shippingRates = data.rates || [];
    selectedShipping = shippingRates[0] || { service: 'Standard', price: 0 };
    renderCartWithShipping(cartSummaryEl);
    renderCartWithShipping(cartSummary2El);
  } catch(err){
    console.error('Shipping API error', err);
    shippingRates = [];
    selectedShipping = { service: 'Standard', price: 0 };
    renderCartWithShipping(cartSummaryEl);
    renderCartWithShipping(cartSummary2El);
  }
}

/* -------------------------
   CART + SHIPPING RENDER
   ------------------------- */
function calcSubtotal(){
  return cart.reduce((s,i)=>s + (i.price * i.qty),0);
}

function renderCartWithShipping(el=cartSummaryEl){
  if(!el) return;
  el.innerHTML = '';

  if(!cart.length){
    el.innerHTML="<p>Your cart is empty.</p>";
    return;
  }

  // Items
  cart.forEach(item=>{
    const div=document.createElement('div');
    div.className='cart-item';
    div.innerHTML=`<div>${item.name} x ${item.qty}</div><div>$${(item.price*item.qty).toFixed(2)} CAD</div>`;
    el.appendChild(div);
  });

  const subtotal = calcSubtotal();
  const shippingCost = selectedShipping?.price ? parseFloat(selectedShipping.price) : 0;
  const total = subtotal + shippingCost;

  // Shipping selector
  const shippingDiv = document.createElement('div');
  shippingDiv.className='summary-line';
  shippingDiv.innerHTML = `<label>Shipping</label><select id="shipping-select"></select>`;
  el.appendChild(shippingDiv);

  const shippingSelect = document.getElementById('shipping-select');
  if(shippingRates.length){
    shippingRates.forEach((r,i)=>{
      const o=document.createElement('option');
      o.value=r.price;
      o.textContent=`${r.service} - $${parseFloat(r.price).toFixed(2)}`;
      if(i===0) o.selected=true;
      shippingSelect.appendChild(o);
    });
    shippingSelect.addEventListener('change', e=>{
      selectedShipping = { service: shippingSelect.options[shippingSelect.selectedIndex].text.split(' - ')[0], price: parseFloat(e.target.value) };
      renderCartWithShipping(el);
    });
  } else {
    const o=document.createElement('option');
    o.textContent='Standard - $0.00';
    o.value=0;
    shippingSelect.appendChild(o);
  }

  // Subtotal, shipping, total
  [['Subtotal',subtotal], ['Shipping', shippingCost], ['Total', total]].forEach(l=>{
    const ln=document.createElement('div');
    ln.className='summary-line';
    ln.innerHTML=`<div>${l[0]}</div><div>$${l[1].toFixed(2)} CAD</div>`;
    el.appendChild(ln);
  });

  // store current totals for Step 2
  el.dataset.subtotal=subtotal.toFixed(2);
  el.dataset.shipping=shippingCost.toFixed(2);
  el.dataset.total=total.toFixed(2);
}

/* -------------------------
   CHECKOUT FORM
   ------------------------- */
if(checkoutForm){
  checkoutForm.addEventListener('submit', e=>{
    e.preventDefault();
    // switch to Step 2
    if(step1) step1.style.display='none';
    if(step2) step2.style.display='block';
    renderCartWithShipping(cartSummary2El);
  });
}

/* -------------------------
   BACK BUTTON
   ------------------------- */
const backBtn = document.getElementById('back-btn');
if(backBtn){
  backBtn.addEventListener('click', ()=>{
    if(step2) step2.style.display='none';
    if(step1) step1.style.display='block';
  });
}

/* -------------------------
   INITIAL RENDER
   ------------------------- */
fetchShippingRates();
renderCartWithShipping(cartSummaryEl);
renderCartWithShipping(cartSummary2El);
</script>
